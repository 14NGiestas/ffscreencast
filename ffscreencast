#!/usr/bin/env bash
#
# @author    Patrick Plocke <patrick@plocke.de>
# @gpg key   0x28BF179F
# @date      2015-09-02
# @licencse  MIT http://opensource.org/licenses/MIT
# @version   0.1
INFO_AUTHOR="Patrick Plocke <patrick@plocke.de>"
INFO_GPGKEY="0x28BF179F"
INFO_DATE="2015-09-02"
INFO_LICENSE="MIT"
INFO_VERSION="0.1"




################################################################################
# File name and path
################################################################################

# Name of the output file
DATE=$(date +%Y-%m-%d)
TIME=$(date +%H.%M.%S)
NAME="Screencast ${DATE} at ${TIME}"

# Where to save it
DIR="${HOME}/Desktop"


################################################################################
# FFmpeg Options
################################################################################

# Get current resolution
#RESO=$(system_profiler SPDisplaysDataType | grep Resolution)
#WIDTH=$(echo $RESO | awk '{print $2}')
#HEIGHT=$(echo $RESO | awk '{print $4}')

# -qp 0 tells x264 to encode in lossless mode,
# -preset ultrafast advises it to do so fast.
#LOSSLESS="-qp 0"
#LOSSLESS=""
#PRESET="ultrafast"
#PIXFMT="uyvy422"


# Specify the container format.
# @param string FF_CONTAINER (mkv, avi)
FF_CONTAINER="mkv"


# Specify franes per second
# @param integer FF_FRAME_RATE
#FF_FRAME_RATE="30"




################################################################################
# VARIABLES (DO NOT EDIT)
################################################################################

#OPTIONS="-framerate ${FF_FRAME_RATE} "
# ffmpeg -f avfoundation -i 1 -c:v libx264rgb -crf 0 -preset:v ultrafast -c:a pcm_s16le -af aresample=async=1:first_pts=0 out.mkv

################################################################################
# FUNCTIONS
################################################################################

usage() {
	printf "%s %s %s\n" "Usage:" "${0}" "[-s[num]] [-a[num]] [-c[num]] [--dry]"
	printf "%s %s %s\n" "      " "${0}" "--slist [--dry]"
	printf "%s %s %s\n" "      " "${0}" "--alist [--dry]"
	printf "%s %s %s\n" "      " "${0}" "--clist [--dry]"
	echo
	echo "When invoked without any arguments, it will start screen recording"
	echo "on the default screen without sound and without camera overlay."
	echo
	echo "Recording options (can be combined):"
	echo "-s[num]       (Default) Enable screen capturing [with device number X]"
	echo "-a[num]       Enable audio capturing [with device number X]"
	echo "-c[num]       Add camera overlay [with device number X]"
	echo
	echo "Behavior options (combine with recording- or list options):"
	echo "--dry         Show the command (without executing)"
	echo
	echo "List options:"
	echo "--slist       List screen capturing devices (monitors)"
	echo "--alist       List audio capturing devices (microphones)"
	echo "--clist       List camera capturing devices (cams)"
	echo
	echo "System information:"
	echo "--help        Show this help screen"
	echo "--version     Show version information"
	echo "--test        Test requirements"
}

version() {
	printf "Version: %s (%s)\n" "${INFO_VERSION}" "${INFO_DATE}"
	printf "Author:  %s (%s)\n" "${INFO_AUTHOR}" "${INFO_GPGKEY}"
	printf "License: %s\n" "${INFO_LICENSE}"
}

################################################################################
# Check requirements
################################################################################

# @param string "verbose"
check_requirements() {
	uname="$(uname)"

	#### 1.) Check Operating System
	if [ "${uname}" != "Linux"  ] && [ "${uname}" != 'Darwin'  ]; then
		echo "Unsupported operating system."
		echo "It currently only works on Linux and OSX."
		echo "Sorry ;-)"
		return 1
	elif [ "${1}" = "verbose" ]; then
		echo "[OK] Operating system supported: ${uname}"
	fi

	#### 2.) Check ffmpeg
	if ! command -v ffmpeg > /dev/null 2>&1; then
		echo "ffmpeg not found."
		return 1
	elif [ "${1}" = "verbose" ]; then
		echo "[OK] ffmpeg found: $(which ffmpeg)"
	fi

	#### 3.) Check OSX
	if [ "${uname}" = "Darwin" ]; then
		if ! ffmpeg -f avfoundation -list_devices true -i "" 2>&1 | grep 'AVFoundation input device' > /dev/null 2>&1; then
			echo "OSX: AVFoundation not available in ffmpeg"
			return 1
		elif [ "${1}" = "verbose" ]; then
			echo "[OK] OSX: AVFoundation available in ffmpeg"
		fi
	fi

	#### 4.) Check Linux
	if [ "${uname}" = "Linux" ]; then
		if ! ffmpeg 2>&1 | grep '\-\-enable-x11grab' > /dev/null 2>&1; then
			echo "Linux: x11grab not available in ffmpeg"
			return 1
		elif [ "${1}" = "verbose" ]; then
			echo "[OK] Linux: x11grab available in ffmpeg"
		fi

		if ! command -v v4l2-ctl > /dev/null 2>&1; then
			echo "Linux: v4l2-ctl not found."
			echo
			echo "Debian: apt-get install v4l-utils"
			echo "CentOS: yum install v4l-utils"
			echo "Arch:   pacman -S v4l-utils"
			return 1
		elif [ "${1}" = "verbose" ]; then
			echo "[OK] Linux: v4l2-ctl found: $(which v4l2-ctl)"
		fi

		if ! command -v arecord > /dev/null 2>&1; then
			echo "Linux: arecord not found."
			echo
			echo "Debian: apt-get install alsa-utils"
			echo "CentOS: yum install alsa-utils"
			echo "Arch:   pacman -S alsa-utils"
			return 1
		elif [ "${1}" = "verbose" ]; then
			echo "[OK] Linux: arecord found: $(which arecord)"
		fi

		if ! command -v xdpyinfo > /dev/null 2>&1; then
			echo "Linux: xdpyinfo not found."
			echo
			echo "Debian: apt-get install x11-utils"
			echo "CentOS: yum install xorg-x11-utils"
			echo "Arch:   pacman -S xorg-xdpyinfo"
			return 1
		elif [ "${1}" = "verbose" ]; then
			echo "[OK] Linux: xdpyinfo found: $(which xdpyinfo)"
		fi
	fi

	return 0
}





################################################################################
# Get OS dependent device names
################################################################################
# @param string "dry": Show command only
get_screen_device_names() {
	if [ "$(uname)" = "Darwin" ]; then
		DEVICE_NAMES="ffmpeg -f avfoundation -list_devices true -i '' 2>&1 | grep 'AVFoundation input' | sed -n '/AVFoundation video/,/AVFoundation audio/p' | grep -oE '\[[0-9]\].*$' | grep 'Capture screen'"
	elif [ "$(uname)" = "Linux" ]; then
		DEVICE_NAMES="xdpyinfo | grep -A 1 -E '^screen #[0-9]*:' | grep -vE '^\-\-' | sed 'N;s/\n/ /' | sed 's/dimensions://g' | sed 's/ \{1,\}/ /g' | awk '{printf \"[%d] %s\n\", NR, \$0}'"
	fi
	[ "${1}" = "yes" ] && echo "${DEVICE_NAMES}" || eval $DEVICE_NAMES
}
get_audio_device_names() {
	if [ "$(uname)" = "Darwin" ]; then
		DEVICE_NAMES="ffmpeg -f avfoundation -list_devices true -i '' 2>&1 | grep 'AVFoundation input' | sed -n '/AVFoundation audio/,\$p' | grep -oE '\[[0-9]\].*$'"
	elif [ "$(uname)" = "Linux" ]; then
		DEVICE_NAMES="arecord -l | grep -E '^card\s[0-9]*:' | awk '{printf \"[%d] %s\n\", NR, \$0}'"
	fi
	[ "${1}" = "yes" ] && echo "${DEVICE_NAMES}" || eval $DEVICE_NAMES
}
get_camera_device_names() {
	if [ "$(uname)" = "Darwin" ]; then
		DEVICE_NAMES="ffmpeg -f avfoundation -list_devices true -i '' 2>&1 | grep 'AVFoundation input' | sed -n '/AVFoundation video/,/AVFoundation audio/p' | grep -oE '\[[0-9]\].*$' | grep 'Camera'"
	elif [ "$(uname)" = "Linux" ]; then
		DEVICE_NAMES="v4l2-ctl --list-devices | grep -B 1 '/dev/video' | grep -vE '^\-\-' | sed 'N;s/\n/ /' | sed 's/ \{1,\}/ /g' | awk '{printf \"[%d] %s\n\", NR, \$0}'"
	fi
	[ "${1}" = "yes" ] && echo "${DEVICE_NAMES}" || eval $DEVICE_NAMES
}


################################################################################
# Get device indices
################################################################################
get_screen_device_indices() {
	devices="$(get_screen_device_names | grep -oE '^\[[0-9]\]' | sed 's/\[//g' | sed 's/\]//g')"
	echo $devices
}
get_audio_device_indices() {
	devices="$(get_audio_device_names | grep -oE '^\[[0-9]\]' | sed 's/\[//g' | sed 's/\]//g')"
	echo $devices
}
get_camera_device_indices() {
	devices="$(get_camera_device_names | grep -oE '^\[[0-9]\]' | sed 's/\[//g' | sed 's/\]//g')"
	echo $devices
}


################################################################################
# Count devices
################################################################################
count_screen_devices() {
	devices="$(get_screen_device_names | grep -c '')"
	echo $devices
}
count_audio_devices() {
	devices="$(get_audio_device_names | grep -c '')"
	echo $devices
}
count_camera_devices() {
	devices="$(get_camera_device_names | grep -c '')"
	echo $devices
}



################################################################################
# Check if device indices exist
################################################################################
screen_device_exists() {
	index=$1
	indices="$(get_screen_device_indices)"
	[[ $indices =~ $index ]] && return 0 || return 1
}
audio_device_exists() {
	index=$1
	indices="$(get_audio_device_indices)"
	[[ $indices =~ $index ]] && return 0 || return 1
}
camera_device_exists() {
	index=$1
	indices="$(get_audio_device_indices)"
	[[ $indices =~ $index ]] && return 0 || return 1
}


################################################################################
# Interactively choose devices
################################################################################
choose_screen_device() {
	indices="$(get_screen_device_indices)"

	# List available devices
	printf "$(tput setaf 2)Available devices:$(tput sgr0)\n%s\n" "$(get_screen_device_names)"

	# Ask for device number
	while true; do
		read -p "$(tput setaf 2)Enter device number:$(tput sgr0) " dn < /dev/tty
		[[ $indices =~ $dn ]] && break || echo 'Wrong device number'
	done
	return $dn
}
choose_audio_device() {
	indices="$(get_audio_device_indices)"

	# List available devices
	printf "$(tput setaf 2)Available devices:$(tput sgr0)\n%s\n" "$(get_audio_device_names)"

	# Ask for device number
	while true; do
		read -p "$(tput setaf 2)Enter device number:$(tput sgr0) " dn < /dev/tty
		[[ $indices =~ $dn ]] && break || echo 'Wrong device number'
	done
	return $dn
}
choose_camera_device() {
	indices="$(get_camera_device_indices)"

	# List available devices
	printf "$(tput setaf 2)Available devices:$(tput sgr0)\n%s\n" "$(get_camera_device_names)"

	# Ask for device number
	while true; do
		read -p "$(tput setaf 2)Enter device number:$(tput sgr0) " dn < /dev/tty
		[[ $indices =~ $dn ]] && break || echo 'Wrong device number'
	done
	return $dn
}

# Test if argument is an integer
# @param  mixed
# @return integer	0: is number | 1: not a number
isint() {
	printf '%d' "$1" >/dev/null 2>&1 && return 0 || return 1;
}


################################################################################
# MAIN ENTRY POINT
################################################################################

########################################
# 1.) Default options
########################################

# Enable screen recording by default
screen=yes


########################################
# 2.) Evaluate cmd arguments
########################################

while [ $# -gt 0  ]; do
	case "$1" in

		# Screen recording
		-s | -s[0-9]*)
			screen=yes
			screen_num="$(echo "$1" | sed 's/^..//g')"
			if [ ${#screen_num} -gt 0 ]; then
				if ! isint ${screen_num} > /dev/null 2>&1; then
					echo "Invalid screen number for -s"
					exit -1
				fi
			fi
			;;

		# Audio recording
		-a | -a[0-9]*)
			audio=yes
			audio_num="$(echo "$1" | sed 's/^..//g')"
			if [ ${#audio_num} -gt 0 ]; then
				if ! isint ${audio_num} > /dev/null 2>&1; then
					echo "Invalid audio number for -a"
					exit -1
				fi
			fi
			;;

		# Camera recording overlay
		-c | -c[0-9]*)
			camera=yes
			camera_num="$(echo "$1" | sed 's/^..//g')"
			if [ ${#camera_num} -gt 0 ]; then
				if ! isint ${camera_num} > /dev/null 2>&1; then
					echo "Invalid camera number for -c"
					exit -1
				fi
			fi
			;;

		--dry)
			l_dry=yes
			;;
		--slist)
			l_slist=yes
			;;
		--alist)
			l_alist=yes
			;;
		--clist)
			l_clist=yes
			;;
		--help)
			l_help=yes
			;;
		--version)
			l_version=yes
			;;
		--test)
			l_test=yes
			;;
		*)
			echo "Invalid argument."
			echo "Type '${0} --help' for available options."
			exit 1
			;;
	esac
	shift
done



########################################
# 3.) Help/Version/Test
########################################
if [ "${l_help}" = "yes" ]; then
	usage
	exit 0
fi
if [ "${l_version}" = "yes" ]; then
	version
	exit 0
fi
if [ "${l_test}" = "yes" ]; then
	if ! check_requirements "verbose"; then
		exit -1
	else
		exit 0
	fi
fi


########################################
# 4.) Check requirements
########################################

if ! check_requirements; then
	exit -1
fi


########################################
# 5.) List options
########################################


if [ "${l_slist}" = "yes" ]; then
	echo "Available screen recording devices (monitors):"
	echo
	get_screen_device_names "${l_dry}"
	exit 0
fi
if [ "${l_alist}" = "yes" ]; then
	echo "Available audio recording devices (microphones):"
	echo
	get_audio_device_names "${l_dry}"
	exit 0
fi
if [ "${l_clist}" = "yes" ]; then
	echo "Available camera recording devices:"
	echo
	get_camera_device_names "${l_dry}"
	exit 0
fi



########################################
# 6.) Build ffmpeg options
########################################

# Does the user want screen recording?
if [ ! -z ${screen+x} ]; then

	# If screen device was set via argument list, validate it
	if [ ${#screen_num} -gt 0 ]; then
		if ! screen_device_exists "$screen_num"; then
			echo "Screen recording device: '${screen_num}' does not exist."
			exit -1
		fi
		screen_device="$screen_num"

	# If screen device was not set via argument list, choose one
	else
		# Use default screen if only one screen exists
		if [ "$(count_screen_devices)" = "1" ]; then
			screen_device=$(get_screen_device_indices)
		else
			choose_screen_device
			screen_device=$?
		fi
	fi
fi

# Does the user want audio recording?
if [ ! -z ${audio+x} ]; then

	# If screen device was set via argument list, validate it
	if [ ${#audio_num} -gt 0 ]; then
		if ! audio_device_exists "$audio_num"; then
			echo "Audio recording device: '${audio_num}' does not exist."
			exit -1
		fi
		audio_device="$audio_num"

	# If audio device was not set via argument list, choose one
	else
		# Use default audio if only one microphone exists
		if [ "$(count_audio_devices)" = "1" ]; then
			audio_device=$(get_audio_device_indices)
		else
			choose_audio_device
			audio_device=$?
		fi
	fi
fi

# Does the user want camera recording?
if [ ! -z ${camera+x} ]; then

	# If camera device was set via argument list, validate it
	if [ ${#camera_num} -gt 0 ]; then
		if ! camera_device_exists "$camera_num"; then
			echo "Camera recording device: '${camera_num}' does not exist."
			exit -1
		fi
		camera_device="$camera_num"

	# If camera device was not set via argument list, choose one
	else
		# Use default camera if only one microphone exists
		if [ "$(count_camera_devices)" = "1" ]; then
			camera_device=$(get_camera_device_indices)
		else
			choose_camera_device
			camera_device=$?
		fi
	fi
fi




########################################
# 7. Build os-specific ffmpeg cmd
########################################


if [ "$(uname)" = "Darwin" ]; then

	if [ ! -z ${audio+x} ]; then
		audio_device=":${audio_device}"
	else
		audio_device=""
	fi

	if [ ! -z ${camera+x} ]; then
		FFMPEG="ffmpeg"
		FFMPEG="${FFMPEG} -hide_banner -loglevel info"
		FFMPEG="${FFMPEG} -f avfoundation -framerate 30 -i \"${screen_device}\""
		FFMPEG="${FFMPEG} -f avfoundation -framerate 30 -video_size 1280x720 -i \"${camera_device}\""
		FFMPEG="${FFMPEG} -filter_complex \"overlay=main_w-overlay_w-10:main_h-overlay_h-10\""
		FFMPEG="${FFMPEG} \"${DIR}/${NAME}.${FF_CONTAINER}\""
	else
		FFMPEG="ffmpeg"
		FFMPEG="${FFMPEG} -hide_banner -loglevel info"
		FFMPEG="${FFMPEG} -f avfoundation -i \"${screen_device}${audio_device}\""
		FFMPEG="${FFMPEG} \"${DIR}/${NAME}.${FF_CONTAINER}\""
	fi

elif [ "$(uname)" = "Linux" ]; then

	if [ ! -z ${camera+x} ]; then
		# TODO:
		FFMPEG="Unsupported"
	else
		# TODO:
		FFMPEG="ffmpeg"
		FFMPEG="${FFMPEG} -hide_banner -loglevel info"
		FFMPEG="${FFMPEG} -f x11grab -i \":0.0\""
		FFMPEG="${FFMPEG} \"${DIR}/${NAME}.${FF_CONTAINER}\""
	fi

fi


#### RUN
if [ "${l_dry}" = "yes" ]; then
	echo "${FFMPEG}"
else
	eval $FFMPEG
fi
